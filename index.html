<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
        /* Stile für den Beenden-Button */
        #exit-button {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background: red;
            color: white;
            border: none;
            font-size: 18px;
            cursor: pointer;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <button id="exit-button">Beenden</button>

    <a-scene 
        webxr="optionalFeatures: hit-test" 
        renderer="colorManagement: true, alpha: true" 
        embedded
        xr-mode-ui="enabled: true">

        <!-- Kamera mit AR-Einstellungen -->
        <a-camera position="0 1.6 0"></a-camera>

        <!-- Virtuelles Fenster (zuerst unsichtbar) -->
        <a-plane id="window" width="1" height="1.5" color="black" opacity="0.3"
                 visible="false"></a-plane>

        <!-- Virtueller Raum (zuerst unsichtbar) -->
        <a-entity id="room" visible="false">
            <a-box position="0 0 -2" width="3" height="3" depth="0.1" color="white"></a-box>
            <a-box position="-1.5 0 -2.5" width="0.1" height="3" depth="3" color="gray"></a-box>
            <a-box position="1.5 0 -2.5" width="0.1" height="3" depth="3" color="gray"></a-box>
        </a-entity>
    </a-scene>

    <script>
        AFRAME.registerComponent('ar-hit-test', {
            init: function () {
                const sceneEl = this.el;
                const windowEl = document.getElementById("window");
                const roomEl = document.getElementById("room");
                const exitButton = document.getElementById("exit-button");

                let xrSession = null;
                let xrHitTestSource = null;
                let xrReferenceSpace = null;

                sceneEl.addEventListener('enter-vr', async function () {
                    if (sceneEl.xrSession) {
                        xrSession = sceneEl.xrSession;

                        // WebXR Reference Space für Hit-Testing
                        xrReferenceSpace = await xrSession.requestReferenceSpace('local');
                        const viewerReferenceSpace = await xrSession.requestReferenceSpace('viewer');
                        xrHitTestSource = await xrSession.requestHitTestSource({ space: viewerReferenceSpace });

                        // Zeige den "Beenden"-Button an
                        exitButton.style.display = "block";
                    }
                });

                sceneEl.addEventListener('exit-vr', function () {
                    xrHitTestSource = null;
                    exitButton.style.display = "none"; // Verstecke den Button
                });

                sceneEl.addEventListener('click', async function () {
                    if (!xrSession || !xrHitTestSource) return;

                    const frame = sceneEl.xrFrame;
                    if (frame) {
                        const hitTestResults = frame.getHitTestResults(xrHitTestSource);
                        if (hitTestResults.length > 0) {
                            const hitPose = hitTestResults[0].getPose(xrReferenceSpace);
                            const position = hitPose.transform.position;

                            // Fenster an die erkannte Wand setzen
                            windowEl.setAttribute("position", `${position.x} ${position.y} ${position.z}`);
                            windowEl.setAttribute("visible", "true");

                            // Raum hinter das Fenster setzen
                            roomEl.setAttribute("position", `${position.x} ${position.y} ${position.z - 0.5}`);
                            roomEl.setAttribute("visible", "true");
                        }
                    }
                });

                // Beenden-Button: XR-Sitzung beenden
                exitButton.addEventListener('click', function () {
                    if (xrSession) {
                        xrSession.end();
                        exitButton.style.display = "none"; // Button wieder verstecken
                    }
                });
            }
        });

        document.querySelector('a-scene').setAttribute('ar-hit-test', '');
    </script>
</body>
</html>
