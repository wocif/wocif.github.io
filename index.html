<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
</head>
<body>
    <a-scene webxr="optionalFeatures: hit-test" renderer="colorManagement: true">
        <!-- Camera -->
        <a-camera position="0 1.6 0"></a-camera>

        <!-- Virtual Window (Initially Hidden) -->
        <a-plane id="window" width="1" height="1.5" color="black" opacity="0.3"
                 visible="false"></a-plane>

        <!-- Virtual Room (Initially Hidden) -->
        <a-entity id="room" visible="false">
            <a-box position="0 0 -2" width="3" height="3" depth="0.1" color="white"></a-box>
            <a-box position="-1.5 0 -2.5" width="0.1" height="3" depth="3" color="gray"></a-box>
            <a-box position="1.5 0 -2.5" width="0.1" height="3" depth="3" color="gray"></a-box>
        </a-entity>
    </a-scene>

    <script>
        AFRAME.registerComponent('ar-hit-test', {
            init: function () {
                const sceneEl = this.el;
                const windowEl = document.getElementById("window");
                const roomEl = document.getElementById("room");

                let xrSession = null;
                let xrHitTestSource = null;

                sceneEl.addEventListener('enter-vr', async function () {
                    if (sceneEl.xrSession) {
                        xrSession = sceneEl.xrSession;

                        // Request hit test source
                        const viewerReferenceSpace = await xrSession.requestReferenceSpace('viewer');
                        const hitTestSource = await xrSession.requestHitTestSource({ space: viewerReferenceSpace });
                        xrHitTestSource = hitTestSource;
                    }
                });

                sceneEl.addEventListener('exit-vr', function () {
                    xrHitTestSource = null;
                });

                sceneEl.addEventListener('click', async function () {
                    if (!xrSession || !xrHitTestSource) return;

                    // Perform a hit test
                    const frame = sceneEl.xrFrame;
                    if (frame) {
                        const hitTestResults = frame.getHitTestResults(xrHitTestSource);
                        if (hitTestResults.length > 0) {
                            const hitPose = hitTestResults[0].getPose(sceneEl.xrReferenceSpace);
                            const position = hitPose.transform.position;

                            // Move window and make it visible
                            windowEl.setAttribute("position", `${position.x} ${position.y} ${position.z}`);
                            windowEl.setAttribute("visible", "true");

                            // Position the room slightly behind the window
                            roomEl.setAttribute("position", `${position.x} ${position.y} ${position.z - 0.5}`);
                            roomEl.setAttribute("visible", "true");
                        }
                    }
                });
            }
        });

        document.querySelector('a-scene').setAttribute('ar-hit-test', '');
    </script>
</body>
</html>
