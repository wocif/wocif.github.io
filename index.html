<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>AR Shop</title>
  <style>
    body { margin: 0; overflow: hidden; }
  </style>
</head>
<body>
<script type="module">
  import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.125.0/build/three.module.js';
  import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.125.0/examples/jsm/loaders/GLTFLoader.js';
  import { RGBELoader } from 'https://cdn.jsdelivr.net/npm/three@0.125.0/examples/jsm/loaders/RGBELoader.js';
  import { ARButton } from 'https://cdn.jsdelivr.net/npm/three@0.125.0/examples/jsm/webxr/ARButton.js';

  // Einfache Implementierung eines Ladebalkens
  class LoadingBar {
    constructor() {
      this.dom = document.createElement('div');
      this.dom.style.position = 'absolute';
      this.dom.style.top = '10px';
      this.dom.style.left = '10px';
      this.dom.style.width = '200px';
      this.dom.style.height = '10px';
      this.dom.style.background = '#ccc';
      document.body.appendChild(this.dom);

      this.bar = document.createElement('div');
      this.bar.style.height = '100%';
      this.bar.style.width = '0%';
      this.bar.style.background = '#76c7c0';
      this.dom.appendChild(this.bar);
      this._visible = true;
    }
    
    set progress(val) {
      this.bar.style.width = `${(val * 100).toFixed(0)}%`;
    }
    
    set visible(val) {
      this.dom.style.display = val ? 'block' : 'none';
      this._visible = val;
    }
    
    get visible() {
      return this._visible;
    }
  }

  class App {
    constructor() {
      const container = document.createElement('div');
      document.body.appendChild(container);
      
      this.loadingBar = new LoadingBar();
      this.loadingBar.visible = false;
      
      // Stelle hier die Pfade zu deinen Assets ein (Ordnerstruktur relativ zur HTML-Datei)
      this.assetsPath = 'assets/ar-shop/';
      
      this.camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
      this.camera.position.set(0, 1.6, 0);
      
      this.scene = new THREE.Scene();
      
      const ambient = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
      ambient.position.set(0.5, 1, 0.25);
      this.scene.add(ambient);
      
      this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      this.renderer.setPixelRatio(window.devicePixelRatio);
      this.renderer.setSize(window.innerWidth, window.innerHeight);
      this.renderer.outputEncoding = THREE.sRGBEncoding;
      this.renderer.xr.enabled = true;
      container.appendChild(this.renderer.domElement);
      
      // Füge den AR-Button hinzu, der die AR-Session startet
      document.body.appendChild(ARButton.createButton(this.renderer, { requiredFeatures: [ 'hit-test' ] }));
      
      this.setEnvironment();
      
      this.reticle = new THREE.Mesh(
        new THREE.RingBufferGeometry(0.15, 0.2, 32).rotateX(-Math.PI / 2),
        new THREE.MeshBasicMaterial({ color: 0x00ff00 })
      );
      this.reticle.matrixAutoUpdate = false;
      this.reticle.visible = false;
      this.scene.add(this.reticle);
      
      this.setupXR();
      
      window.addEventListener('resize', this.resize.bind(this));
    }
    
    setupXR() {
      const self = this;
      
      this.hitTestSourceRequested = false;
      this.hitTestSource = null;
      
      function onSelect() {
        if (self.chair === undefined) return;
        if (self.reticle.visible) {
          self.chair.position.setFromMatrixPosition(self.reticle.matrix);
          self.chair.visible = true;
        }
      }
      
      this.controller = this.renderer.xr.getController(0);
      this.controller.addEventListener('select', onSelect);
      this.scene.add(this.controller);
    }
    
    resize() {
      this.camera.aspect = window.innerWidth / window.innerHeight;
      this.camera.updateProjectionMatrix();
      this.renderer.setSize(window.innerWidth, window.innerHeight);
    }
    
    setEnvironment() {
      const loader = new RGBELoader().setDataType(THREE.UnsignedByteType);
      const pmremGenerator = new THREE.PMREMGenerator(this.renderer);
      pmremGenerator.compileEquirectangularShader();
      
      const self = this;
      loader.load('assets/hdr/venice_sunset_1k.hdr', (texture) => {
        const envMap = pmremGenerator.fromEquirectangular(texture).texture;
        pmremGenerator.dispose();
        self.scene.environment = envMap;
      }, undefined, (err) => {
        console.error('An error occurred setting the environment');
      });
    }
    
    showChair(id) {
      this.initAR();
      
      const loader = new GLTFLoader().setPath(this.assetsPath);
      const self = this;
      
      this.loadingBar.visible = true;
      
      // Lade das glTF-Modell (z. B. einen Stuhl)
      loader.load(
        `chair${id}.glb`,
        function (gltf) {
          self.scene.add(gltf.scene);
          self.chair = gltf.scene;
          self.chair.visible = false;
          self.loadingBar.visible = false;
          self.renderer.setAnimationLoop(self.render.bind(self));
        },
        function (xhr) {
          self.loadingBar.progress = xhr.loaded / xhr.total;
        },
        function (error) {
          console.error('An error happened', error);
        }
      );
    }
    
    initAR() {
      // Hier könntest du weitere AR-Initialisierungen vornehmen.
      // In diesem Beispiel übernimmt der ARButton die Session-Initialisierung.
    }
    
    requestHitTestSource() {
      const self = this;
      const session = this.renderer.xr.getSession();
      
      session.requestReferenceSpace('viewer').then(function (referenceSpace) {
        session.requestHitTestSource({ space: referenceSpace }).then(function (source) {
          self.hitTestSource = source;
        });
      });
      
      session.addEventListener('end', function () {
        self.hitTestSourceRequested = false;
        self.hitTestSource = null;
      });
      
      this.hitTestSourceRequested = true;
    }
    
    getHitTestResults(frame) {
      const hitTestResults = frame.getHitTestResults(this.hitTestSource);
      if (hitTestResults.length) {
        const referenceSpace = this.renderer.xr.getReferenceSpace();
        const hit = hitTestResults[0];
        const pose = hit.getPose(referenceSpace);
        this.reticle.visible = true;
        this.reticle.matrix.fromArray(pose.transform.matrix);
      } else {
        this.reticle.visible = false;
      }
    }
    
    render(timestamp, frame) {
      if (frame) {
        if (this.hitTestSourceRequested === false) this.requestHitTestSource();
        if (this.hitTestSource) this.getHitTestResults(frame);
      }
      this.renderer.render(this.scene, this.camera);
    }
  }
  
  // Erzeuge die App-Instanz und lade testweise einen Stuhl (ID 1)
  const app = new App();
  app.showChair(1);
</script>
</body>
</html>
