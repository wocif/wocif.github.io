<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXR AR Knight</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/loaders/RGBELoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/webxr/ARButton.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
    </style>
</head>
<body>
    <script>
        class App {
            constructor() {
                const container = document.createElement('div');
                document.body.appendChild(container);
                
                this.clock = new THREE.Clock();
                
                this.camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
                this.camera.position.set(0, 1.6, 3);
                
                this.scene = new THREE.Scene();
                const ambient = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 2);
                ambient.position.set(0.5, 1, 0.25);
                this.scene.add(ambient);
                
                const light = new THREE.DirectionalLight();
                light.position.set(0.2, 1, 1);
                this.scene.add(light);
                
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setPixelRatio(window.devicePixelRatio);
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.outputEncoding = THREE.sRGBEncoding;
                this.renderer.xr.enabled = true;
                container.appendChild(this.renderer.domElement);
                
                this.setEnvironment();
                this.initScene();
                this.setupXR();
                
                window.addEventListener('resize', this.resize.bind(this));
            }

            setEnvironment() {
                const loader = new THREE.RGBELoader().setDataType(THREE.UnsignedByteType);
                const pmremGenerator = new THREE.PMREMGenerator(this.renderer);
                pmremGenerator.compileEquirectangularShader();
                
                loader.load('https://threejs.org/examples/textures/equirectangular/venice_sunset_1k.hdr', (texture) => {
                    const envMap = pmremGenerator.fromEquirectangular(texture).texture;
                    pmremGenerator.dispose();
                    this.scene.environment = envMap;
                }, undefined, () => {
                    console.error('Error loading environment');
                });
            }

            resize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }

            loadKnight() {
                const loader = new THREE.GLTFLoader();
                loader.load('https://threejs.org/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.gltf', (gltf) => {
                    this.knight = gltf.scene;
                    this.knight.scale.set(0.5, 0.5, 0.5);
                    this.knight.visible = false;
                    this.scene.add(this.knight);
                }, undefined, () => {
                    console.log('Error loading model');
                });
            }

            initScene() {
                this.reticle = new THREE.Mesh(
                    new THREE.RingGeometry(0.15, 0.2, 32).rotateX(-Math.PI / 2),
                    new THREE.MeshBasicMaterial()
                );
                this.reticle.matrixAutoUpdate = false;
                this.reticle.visible = false;
                this.scene.add(this.reticle);
                
                this.loadKnight();
            }

            setupXR() {
                document.body.appendChild(THREE.ARButton.createButton(this.renderer));
                this.controller = this.renderer.xr.getController(0);
                this.controller.addEventListener('select', () => {
                    if (!this.knight || !this.reticle.visible) return;
                    this.knight.position.setFromMatrixPosition(this.reticle.matrix);
                    this.knight.visible = true;
                });
                this.scene.add(this.controller);
            }

            render() {
                this.renderer.setAnimationLoop(() => {
                    this.renderer.render(this.scene, this.camera);
                });
            }
        }
        new App();
    </script>
</body>
</html>
