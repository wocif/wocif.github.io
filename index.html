<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>AR Rechteck mit Rotation und Skalierung</title>
  <style>
    body { margin: 0; overflow: hidden; }
  </style>
</head>
<body>
<script type="module">
  import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.125.0/build/three.module.js';
  import { ARButton } from 'https://cdn.jsdelivr.net/npm/three@0.125.0/examples/jsm/webxr/ARButton.js';

  class App {
    constructor() {
      const container = document.createElement('div');
      document.body.appendChild(container);

      this.camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
      this.scene = new THREE.Scene();

      const ambient = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
      this.scene.add(ambient);

      this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      this.renderer.setSize(window.innerWidth, window.innerHeight);
      this.renderer.xr.enabled = true;
      container.appendChild(this.renderer.domElement);

      document.body.appendChild(ARButton.createButton(this.renderer, { requiredFeatures: ['hit-test'] }));

      this.reticle = new THREE.Mesh(
        new THREE.RingBufferGeometry(0.15, 0.2, 32).rotateX(-Math.PI / 2),
        new THREE.MeshBasicMaterial({ color: 0x00ff00 })
      );
      this.reticle.matrixAutoUpdate = false;
      this.reticle.visible = false;
      this.scene.add(this.reticle);

      this.setupXR();
      this.createRectangle();
      this.state = 0; // 0: Platzieren, 1: Rotieren, 2: Skalieren
      this.renderer.setAnimationLoop(this.render.bind(this));
    }

    setupXR() {
      this.hitTestSourceRequested = false;
      this.hitTestSource = null;

      this.controller = this.renderer.xr.getController(0);
      //this.controller.addEventListener('select', this.onSelect.bind(this));
      this.startGamepadListening();
      this.scene.add(this.controller);
    }

    createRectangle() {
      const geometry = new THREE.PlaneGeometry(0.4, 0.2);
      const material = new THREE.MeshStandardMaterial({ color: 0x0000ff, side: THREE.DoubleSide });
      this.rectangle = new THREE.Mesh(geometry, material);
      this.rectangle.visible = false;
      this.scene.add(this.rectangle);
    }

    startGamepadListening() {
      setInterval(() => {
          if (!navigator.getGamepads) return;

          const gamepads = navigator.getGamepads();
          if (!gamepads) return;

          for (const gamepad of gamepads) {
              if (gamepad && gamepad.buttons[4].pressed) {
                  this.onSelect(); // Ruft die ursprüngliche Methode auf
              }
          }
      }, 100); // Alle 100ms prüfen
    }


    onSelect() {
      if (this.state === 0) { // Platzierung
        this.rectangle.position.setFromMatrixPosition(this.reticle.matrix);
        this.rectangle.visible = true;
        this.state = 1;
      } else if (this.state === 1) { // Rotation 
        this.state = 2;
      } else if (this.state === 2) { // Höhe
        this.state = 3; 
      } else if (this.state === 3) { // Größe
        this.state = 4;
      }
    }

    requestHitTestSource() {
      const session = this.renderer.xr.getSession();
      session.requestReferenceSpace('viewer').then(refSpace => {
        session.requestHitTestSource({ space: refSpace }).then(source => {
          this.hitTestSource = source;
        });
      });
      session.addEventListener('end', () => {
        this.hitTestSourceRequested = false;
        this.hitTestSource = null;
      });
      this.hitTestSourceRequested = true;
    }

    getHitTestResults(frame) {
      const hitTestResults = frame.getHitTestResults(this.hitTestSource);
      if (hitTestResults.length) {
        const referenceSpace = this.renderer.xr.getReferenceSpace();
        const pose = hitTestResults[0].getPose(referenceSpace);
        this.reticle.visible = true;
        this.reticle.matrix.fromArray(pose.transform.matrix);
      } else {
        this.reticle.visible = false;
      }
    }


    render(timestamp, frame) {
      if (frame) {
        if (!this.hitTestSourceRequested) this.requestHitTestSource();
        if (this.hitTestSource) this.getHitTestResults(frame);
      }

      const session = this.renderer.xr.getSession();
      if (session) {
        for (const inputSource of session.inputSources) {
          if (inputSource.gamepad) {
            const gamepad = inputSource.gamepad;
            const xAxis = gamepad.axes[2]; // Daumenstick horizontal
            const yAxis = gamepad.axes[3]; // Daumenstick vertikal
            const bKnob = gamepad.buttons[5];
            const aKnob = gamepad.buttons[4];

            if (this.state === 1) { // Rotation
              this.rectangle.rotation.y += xAxis * 0.025;

            } else if (this.state === 2) { //Höhe Position
                this.rectangle.position.y += yAxis * 0.05;

            } else if (this.state === 3) { // Skalierung
              const scale = Math.max(0.1, this.rectangle.scale.x + yAxis * 0.02);
              this.rectangle.scale.set(scale, scale, scale);
            }
          }
        }
      }

      this.renderer.render(this.scene, this.camera);
    }
  }

  new App();
</script>
</body>
</html>
